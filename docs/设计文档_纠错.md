# 时间线纠错功能实现说明

## 功能概述
为时间线叙事模式添加了完整的AI纠错功能，用户可以在输入窗口点击纠错按钮，实时查看AI纠错过程，并选择接受、重试或取消纠错结果。

## 实现的文件

### 1. 文本差异对比工具类
**文件**: `lib/util/text_diff_util.dart`

**功能**:
- 实现了基于LCS（最长公共子序列）算法的文本差异对比
- 支持字符级和词语级的智能对比
- 能够识别文本的删除、插入和相同部分
- 对中文文本友好，支持中英文混合分词

**关键类**:
- `DiffType`: 差异类型枚举（equal, delete, insert）
- `DiffSegment`: 文本差异片段
- `TextDiffResult`: 差异对比结果
- `TextDiffUtil`: 工具类（提供diff和smartDiff方法）

### 2. 流式纠错界面组件
**文件**: `lib/view/widgets/text_correction_stream_dialog.dart`

**功能**:
- 显示AI实时纠错过程
- 删除的内容用删除线和浅灰色标记
- 纠正的内容用紫色高亮
- 底部显示"AI 纠错中..."状态指示

**UI特点**:
- 全屏对话框，可滚动内容区域
- 左上角关闭按钮
- 实时渲染文本差异
- 紫色钻石图标 + "AI 纠错中..." 状态提示

**参考设计**: `assets/correcting.jpeg`

### 3. 纠错结果确认对话框
**文件**: `lib/view/widgets/text_correction_confirm_dialog.dart`

**功能**:
- 展示纠错完成后的结果
- 显示变更摘要（错别字修正、冗余表达删减）
- 提供三个操作按钮：接受、取消、重试

**UI特点**:
- 纠错文本带高亮显示（删除线+紫色）
- "AI 已完成指令"横幅（紫色背景）
- 变更摘要（子弹列表）
- 三个操作按钮（接受/取消/重试）

**操作说明**:
- **接受**: 替换输入框文本为纠错后的文本
- **取消**: 保留原始文本
- **重试**: 重新调用AI进行纠错

**参考设计**: `assets/correct_dialog.jpeg`

### 4. 时间线页面集成
**文件**: `lib/view/pages/diary_timeline_page.dart`

**修改内容**:
1. 添加导入:
   - `dart:async`
   - `ai_service.dart`
   - `text_correction_stream_dialog.dart`
   - `text_correction_confirm_dialog.dart`

2. 新增方法:
   - `_onCorrection()`: 纠错按钮点击处理
   - `_performCorrection(String originalText)`: 执行纠错流程（支持重试）

3. UI修改:
   - 在AI总结和日记列表按钮之间添加纠错按钮
   - 按钮图标: `Icons.auto_fix_high`（紫色）
   - 按钮提示: "纠错"

## 技术实现

### 纠错流程
```
1. 用户点击纠错按钮
   ↓
2. 验证输入框有内容
   ↓
3. 创建StreamController
   ↓
4. 显示流式纠错对话框
   ↓
5. 调用AiService.processTextStream (promptType='correction')
   ↓
6. 实时接收AI返回的纠错文本片段 (onDelta)
   ↓
7. 在流式对话框中实时显示差异对比
   ↓
8. AI完成后关闭流式对话框 (onDone)
   ↓
9. 显示确认对话框
   ↓
10. 用户选择操作:
    - 接受: 替换输入框文本
    - 重试: 回到步骤3
    - 取消: 保留原文
```

### 文本差异对比算法
使用动态规划算法计算最长公共子序列（LCS），然后通过回溯构建差异片段:
- **删除**: 原文中有但纠错文本中没有的内容
- **插入**: 纠错文本中有但原文中没有的内容（即纠正后的内容）
- **相同**: 两者共有的内容

### 智能分词
支持中英文混合文本的智能分词:
- 中文字符单独成词
- 英文单词整体处理
- 标点符号单独分离
- 提高了差异对比的准确性

### Stream处理
```dart
final streamController = StreamController<String>();

// 在onDelta中添加数据
streamController.add(chunk);

// 在onDone中关闭流
await streamController.close();

// 在Widget中订阅流
correctionStream.listen((chunk) {
  setState(() {
    _currentCorrectedText += chunk;
  });
});
```

## 视觉设计

### 颜色方案（适配深浅色主题）

#### 浅色主题
- **正常文本**: 黑色 (`Colors.black87`)
- **删除内容**: 灰色 (`Colors.grey.shade600`) + 删除线
- **修正内容**: 浅紫色 (`Color(0xFFBA68C8)`) + 加粗
- **背景**: 白色/浅灰色

#### 深色主题
- **正常文本**: 白色 (`Colors.white.withOpacity(0.87)`)
- **删除内容**: 灰色 (`Colors.grey.shade500`) + 删除线
- **修正内容**: 浅紫色 (`Color(0xFFCE93D8)`) + 加粗
- **背景**: 深色

#### 主题色
- **主题色**: 紫色系 (`Colors.purple.shade400-600`)
- **按钮**: 紫色 (`Colors.purple.shade400`)
- **AI图标**: 紫色渐变背景

### 图标
- **纠错按钮**: `Icons.auto_fix_high` (紫色)
- **AI标识**: `Icons.auto_awesome` (紫色渐变背景)
- **接受**: `Icons.check`
- **取消**: `Icons.close`
- **重试**: `Icons.refresh`

### 布局
- **对话框圆角**: 16px
- **按钮圆角**: 8px
- **内边距**: 20px (对话框), 14px (按钮垂直)
- **字体大小**: 16px (正文), 14px (摘要), 12px (提示)

## 依赖的现有服务

### AiService
- `processTextStream()`: 流式文本处理
  - 参数: `content`, `promptType`, `onDelta`, `onDone`, `onError`
  - 使用correction类型的prompt
  - 支持OpenAI兼容API

### PromptConfig
- 纠错提示词已存在于系统中
- 类型: `PromptCategory.correction`
- 中文纠错提示词: 纠正错别字、语法错误、删除冗余表达

## 使用说明

### 用户操作步骤
1. 在时间线叙事模式的输入框中输入文本
2. 点击紫色的纠错按钮（✨图标）
3. 查看AI实时纠错过程（删除线和紫色高亮）
4. 等待纠错完成，查看变更摘要
5. 选择操作：
   - 点击"接受"：将纠错后的文本替换到输入框
   - 点击"取消"：保留原始文本
   - 点击"重试"：重新进行纠错

### 注意事项
1. 需要先配置AI模型服务（baseUrl, apiKey, model）
2. 需要启用correction类型的prompt
3. 纠错按钮仅在输入框有内容时可用
4. 纠错过程中不能进行其他操作
5. 支持重试功能，可以多次尝试获得更好的纠错结果

## 错误处理
- 空输入提示: "请先输入文本内容"
- AI服务错误: 显示具体错误信息
- 网络错误: "无法连接到大模型服务"
- 配置错误: "大模型配置异常"

## 测试建议
1. **基本功能测试**:
   - 输入包含错别字的文本，测试纠错效果
   - 输入包含冗余表达的文本，测试删减效果
   - 测试接受、取消、重试三个操作

2. **边界情况测试**:
   - 空输入
   - 极长文本
   - 特殊字符
   - 中英文混合

3. **错误场景测试**:
   - AI服务不可用
   - 网络中断
   - 配置缺失

4. **UI测试**:
   - 验证删除线和紫色高亮显示正确
   - 验证流式更新流畅
   - 验证对话框布局在不同屏幕尺寸下的表现

## 未来优化建议
1. 添加纠错历史记录
2. 支持自定义纠错规则
3. 添加纠错前后对比模式切换
4. 优化长文本的差异对比性能
5. 支持批量纠错
6. 添加纠错统计和分析
