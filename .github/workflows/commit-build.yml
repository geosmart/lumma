name: Commit Build

on:
  push:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - '.github/**'

jobs:
  commit-build:
    name: Build APK from Commit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true

    - name: Disable Flutter Analytics
      run: flutter config --no-analytics

    - name: Get Dependencies
      run: flutter pub get

    - name: Create Environment File
      run: |
        cat > .env.release << EOF
        MODEL_PROVIDER=openrouter
        MODEL_BASE_URL=https://openrouter.ai/api/v1
        MODEL_API_KEY=sk-or-v1
        MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
        USE_LOCAL_CONFIG=false
        EOF

    - name: Generate Build Info
      id: build_info
      run: |
        COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
        BUILD_NAME="dev-$COMMIT_SHORT"
        BUILD_NUMBER="${{ github.run_number }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)

        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "build_name=$BUILD_NAME" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

        echo "ğŸ”¨ Building commit: ${{ github.sha }}"
        echo "ğŸ“¦ Build name: $BUILD_NAME"
        echo "ğŸ”¢ Build number: $BUILD_NUMBER"

    - name: Build Release APK
      run: |
        echo "ğŸš€ Building release APK..."
        flutter build apk \
          --release \
          --build-name="${{ steps.build_info.outputs.build_name }}" \
          --build-number="${{ steps.build_info.outputs.build_number }}"

    - name: Prepare APK
      run: |
        mkdir -p build-output

        # Copy and rename APK
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          APK_NAME="lumma-commit-${{ steps.build_info.outputs.commit_short }}-${{ steps.build_info.outputs.timestamp }}.apk"
          cp "build/app/outputs/flutter-apk/app-release.apk" "build-output/$APK_NAME"
          echo "âœ… APK ready: $APK_NAME"

          # Get APK size
          APK_SIZE=$(ls -lh "build-output/$APK_NAME" | awk '{print $5}')
          echo "ğŸ“ APK size: $APK_SIZE"
          echo "apk_name=$APK_NAME" >> $GITHUB_ENV
          echo "apk_size=$APK_SIZE" >> $GITHUB_ENV
        else
          echo "âŒ APK not found!"
          exit 1
        fi

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: lumma-commit-${{ steps.build_info.outputs.commit_short }}
        path: build-output/*.apk
        retention-days: 15

    - name: Build Success Summary
      run: |
        echo "## ğŸ“± Commit Build Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Short Hash**: \`${{ steps.build_info.outputs.commit_short }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number**: \`${{ steps.build_info.outputs.build_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **APK Size**: \`${{ env.apk_size }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Download" >> $GITHUB_STEP_SUMMARY
        echo "APKæ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifactsï¼Œç‚¹å‡»ä¸‹é¢é“¾æ¥ä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— [ä¸‹è½½APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“± å®‰è£…è¯´æ˜" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨'æœªçŸ¥æ¥æº'å®‰è£…" >> $GITHUB_STEP_SUMMARY
        echo "3. å®‰è£…APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> ğŸ’¡ è¿™æ˜¯å¼€å‘ç‰ˆæœ¬ï¼Œå¦‚éœ€æ­£å¼ç‰ˆæœ¬è¯·ç­‰å¾…Releaseå‘å¸ƒ"

    - name: Commit Build Info
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "ğŸ“± APK: ${{ env.apk_name }}"
        echo "ğŸ’¾ å¤§å°: ${{ env.apk_size }}"
        echo "ğŸ“¥ ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
