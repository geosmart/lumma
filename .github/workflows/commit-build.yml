name: Commit Build

on:
  push:
    branches:
      - main
      - master
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - '.github/**'

jobs:
  commit-build:
    name: Build APK from Commit
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true

    - name: Disable Flutter Analytics
      run: flutter config --no-analytics

    - name: Get Dependencies
      run: flutter pub get

    - name: Create Environment File
      run: |
        cat > .env.release << EOF
        MODEL_PROVIDER=openrouter
        MODEL_BASE_URL=https://openrouter.ai/api/v1
        MODEL_API_KEY=sk-or-v1
        MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
        USE_LOCAL_CONFIG=false
        EOF

    - name: Generate Build Info
      id: build_info
      run: |
        COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
        BUILD_NAME="dev-$COMMIT_SHORT"
        BUILD_NUMBER="${{ github.run_number }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)

        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "build_name=$BUILD_NAME" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT

        echo "🔨 Building commit: ${{ github.sha }}"
        echo "📦 Build name: $BUILD_NAME"
        echo "🔢 Build number: $BUILD_NUMBER"

    - name: Build Release APK
      run: |
        echo "🚀 Building release APK..."
        flutter build apk \
          --release \
          --build-name="${{ steps.build_info.outputs.build_name }}" \
          --build-number="${{ steps.build_info.outputs.build_number }}"

    - name: Prepare APK
      run: |
        mkdir -p build-output

        # Copy and rename APK
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          APK_NAME="lumma-commit-${{ steps.build_info.outputs.commit_short }}-${{ steps.build_info.outputs.timestamp }}.apk"
          cp "build/app/outputs/flutter-apk/app-release.apk" "build-output/$APK_NAME"
          echo "✅ APK ready: $APK_NAME"

          # Get APK size
          APK_SIZE=$(ls -lh "build-output/$APK_NAME" | awk '{print $5}')
          echo "📏 APK size: $APK_SIZE"
          echo "apk_name=$APK_NAME" >> $GITHUB_ENV
          echo "apk_size=$APK_SIZE" >> $GITHUB_ENV
        else
          echo "❌ APK not found!"
          exit 1
        fi

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: lumma-commit-${{ steps.build_info.outputs.commit_short }}
        path: build-output/*.apk
        retention-days: 15

    - name: Build Success Summary
      run: |
        echo "## 📱 Commit Build Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📋 Build Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Short Hash**: \`${{ steps.build_info.outputs.commit_short }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number**: \`${{ steps.build_info.outputs.build_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **APK Size**: \`${{ env.apk_size }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 Download" >> $GITHUB_STEP_SUMMARY
        echo "APK文件已上传到Artifacts，点击下面链接下载：" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🔗 [下载APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📱 安装说明" >> $GITHUB_STEP_SUMMARY
        echo "1. 下载APK文件" >> $GITHUB_STEP_SUMMARY
        echo "2. 在Android设备上启用'未知来源'安装" >> $GITHUB_STEP_SUMMARY
        echo "3. 安装APK文件" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> 💡 这是开发版本，如需正式版本请等待Release发布"

    - name: Commit Build Info
      run: |
        echo "🎉 构建完成！"
        echo "📱 APK: ${{ env.apk_name }}"
        echo "💾 大小: ${{ env.apk_size }}"
        echo "📥 下载地址: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
