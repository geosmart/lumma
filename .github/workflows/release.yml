name: Release Build

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: lumma

jobs:
  releaseAndroid:
    name: Release Android
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.5'
          channel: 'stable'
          cache: true

      - name: Verify Flutter Installation
        run: |
          flutter config --no-analytics
          flutter doctor -v
          flutter --version

      - name: Install Dependencies
        run: flutter pub get

      - name: Extract Version Info
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(echo $TAG | sed 's/^v//')
          BUILD_NUM="${{ github.run_number }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

          echo "=== Build Info ==="
          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUM"

      - name: Create Environment File
        run: |
          cat > .env.release << EOF
          MODEL_PROVIDER=openrouter
          MODEL_BASE_URL=https://openrouter.ai/api/v1
          MODEL_API_KEY=sk-or-v1
          MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
          USE_LOCAL_CONFIG=false
          EOF

      - name: Setup Android Signing
        run: |
          # ä½¿ç”¨è°ƒè¯•ç­¾åè¿›è¡ŒGitHub Actionsæž„å»º
          # åœ¨androidç›®å½•ä¸‹åˆ›å»ºè°ƒè¯•keystoreçš„ç¬¦å·é“¾æŽ¥
          cd android
          if [ ! -f "app/debug.keystore" ]; then
            # å¦‚æžœdebug.keystoreä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            keytool -genkey -v -keystore app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi

          # åˆ›å»ºä¸´æ—¶çš„release keystoreæŒ‡å‘debug keystore
          if [ ! -f "my-release-key.jks" ]; then
            cp app/debug.keystore my-release-key.jks
          fi

      - name: Build Android Release APK
        run: |
          flutter build apk \
            --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build_number }}" \
            --split-per-abi \
            --no-shrink

      - name: Prepare Release Files
        run: |
          mkdir -p release-files

          # Copy APK files with better naming
          if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" \
               "release-files/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_arm64.apk"
          fi

          if [ -f "build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk" \
               "release-files/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_arm.apk"
          fi

          if [ -f "build/app/outputs/flutter-apk/app-x86_64-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-x86_64-release.apk" \
               "release-files/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_amd64.apk"
          fi

          # Fallback: if split APKs don't exist, use universal APK
          if [ ! -f "release-files/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_arm64.apk" ]; then
            if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              cp "build/app/outputs/flutter-apk/app-release.apk" \
                 "release-files/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_universal.apk"
            fi
          fi

          echo "ðŸ“¦ Release files:"
          ls -la release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ env.APP_NAME }} ${{ steps.version.outputs.tag }}
          files: release-files/*.apk
          body: |
            # ðŸŒŸ ${{ env.APP_NAME }} ${{ steps.version.outputs.tag }}

            **AIé©±åŠ¨çš„æ™ºèƒ½é—®ç­”æ—¥è®°åº”ç”¨**

            ## ðŸ“± ä¸‹è½½å®‰è£…

            ### APKæ–‡ä»¶è¯´æ˜Ž
            - **arm64.apk**: 64ä½ARMå¤„ç†å™¨ç‰ˆæœ¬ï¼ˆæŽ¨èï¼Œé€‚ç”¨äºŽå¤§å¤šæ•°çŽ°ä»£Androidè®¾å¤‡ï¼‰
            - **arm.apk**: 32ä½ARMå¤„ç†å™¨ç‰ˆæœ¬ï¼ˆå…¼å®¹æ—§è®¾å¤‡ï¼‰
            - **amd64.apk**: x86_64å¤„ç†å™¨ç‰ˆæœ¬ï¼ˆé€‚ç”¨äºŽæ¨¡æ‹Ÿå™¨æˆ–x86è®¾å¤‡ï¼‰
            - **universal.apk**: é€šç”¨ç‰ˆæœ¬ï¼ˆå¦‚æžœä¸Šè¿°ç‰ˆæœ¬ä¸å¯ç”¨ï¼‰

            ### å®‰è£…æ­¥éª¤
            1. æ ¹æ®è®¾å¤‡å¤„ç†å™¨æž¶æž„ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
            2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
            3. å®‰è£…APKæ–‡ä»¶
            4. é¦–æ¬¡ä½¿ç”¨æ—¶é…ç½®AIæ¨¡åž‹API

            ## âœ¨ ä¸»è¦åŠŸèƒ½
            - ðŸ¤– AIé—®ç­”å¼æ—¥è®°è®°å½•
            - ðŸŽ¨ æ·¡é›…/æ·±è‰²ä¸»é¢˜åˆ‡æ¢
            - ðŸ“ å¤šç§æ—¥è®°æ¨¡å¼
            - ðŸ’¬ æ™ºèƒ½é—®é¢˜ç”Ÿæˆ
            - ðŸ“± çŽ°ä»£åŒ–UIè®¾è®¡

            ## ðŸ”§ æŠ€æœ¯ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **æž„å»ºå·**: ${{ steps.version.outputs.build_number }}
            - **æäº¤**: ${{ github.sha }}
            - **Flutterç‰ˆæœ¬**: 3.32.5

            ---

            > ðŸ’¡ å¦‚æžœé‡åˆ°å®‰è£…æˆ–ä½¿ç”¨é—®é¢˜ï¼Œè¯·åœ¨Issuesä¸­åé¦ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  releaseLinux:
    name: Release Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.5'
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y ninja-build libgtk-3-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libunwind-dev imagemagick

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Extract Version Info
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(echo $TAG | sed 's/^v//')
          BUILD_NUM="${{ github.run_number }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

      - name: Create Environment File
        run: |
          cat > .env.release << EOF
          MODEL_PROVIDER=openrouter
          MODEL_BASE_URL=https://openrouter.ai/api/v1
          MODEL_API_KEY=sk-or-v1
          MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
          USE_LOCAL_CONFIG=false
          EOF

      - name: Build Linux
        run: |
          flutter build linux \
            --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build_number }}"

      - name: Create Linux AppImage
        run: |
          # Install linuxdeploy and appimagetool
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy application
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/

          # Create a simple icon
          if [ -f "assets/icon/icon.jpg" ]; then
            # Convert existing icon to PNG
            convert assets/icon/icon.jpg -resize 256x256 AppDir/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png
          else
            # Create a simple placeholder icon
            convert -size 256x256 xc:'#4A90E2' -fill white -pointsize 72 -gravity center -annotate +0+0 'L' AppDir/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png
          fi

          # Copy icon to AppDir root (required for AppImage)
          cp AppDir/usr/share/icons/hicolor/256x256/apps/${{ env.APP_NAME }}.png AppDir/${{ env.APP_NAME }}.png

          # Create desktop entry in standard location
          cat > AppDir/usr/share/applications/${{ env.APP_NAME }}.desktop << 'DESKTOPEOF'
          [Desktop Entry]
          Type=Application
          Name=Lumma
          Comment=AIé©±åŠ¨çš„æ™ºèƒ½é—®ç­”æ—¥è®°åº”ç”¨
          Exec=lumma
          Icon=lumma
          Categories=Office;
          Terminal=false
          DESKTOPEOF

          # Copy desktop file to AppDir root (required for AppImage)
          cp AppDir/usr/share/applications/${{ env.APP_NAME }}.desktop AppDir/${{ env.APP_NAME }}.desktop

          # Create AppRun executable
          cat > AppDir/AppRun << 'APPRUNEOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/lumma" "$@"
          APPRUNEOF
          chmod +x AppDir/AppRun

          # List structure for debugging
          echo "AppDir structure:"
          find AppDir -type f | head -20

          # Create AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage

          # Rename AppImage
          mv *.AppImage ${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_amd64.AppImage

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_amd64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
