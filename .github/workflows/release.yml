name: Release Build

on:
  push:
    bra    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
      - main
      - master
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      force_release:
        description: 'Force create release even from branch'
        required: false
        default: false
        type: boolean

jobs:
  release:
    name: Create Release Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true

    - name: Verify Flutter Installation
      run: |
        flutter config --no-analytics
        flutter doctor -v
        flutter --version

    - name: Install Dependencies
      run: flutter pub get

    - name: Run Tests
      run: flutter test
      continue-on-error: true

    - name: Create Environment File
      run: |
        cat > .env.release << EOF
        MODEL_PROVIDER=openrouter
        MODEL_BASE_URL=https://openrouter.ai/api/v1
        MODEL_API_KEY=sk-or-v1
        MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
        USE_LOCAL_CONFIG=false
        EOF    - name: Extract Version Info
      id: version
      run: |
        # åˆ¤æ–­è§¦å‘ç±»åž‹
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # æ ‡ç­¾è§¦å‘
          TAG="${{ github.ref_name }}"
          IS_TAG=true
          echo "Triggered by tag: $TAG"
        elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          # æ‰‹åŠ¨è§¦å‘
          TAG="${{ github.event.inputs.tag_name }}"
          IS_TAG="${{ github.event.inputs.force_release }}"
          echo "Manual trigger with tag: $TAG"
        else
          # æäº¤è§¦å‘
          TAG="commit-${{ github.sha }}"
          IS_TAG=false
          echo "Triggered by commit: ${{ github.sha }}"
        fi

        VERSION=$(echo $TAG | sed 's/^v//' | sed 's/^commit-//')
        BUILD_NUM="${{ github.run_number }}"

        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT
        echo "is_tag=$IS_TAG" >> $GITHUB_OUTPUT
        echo "is_release=$IS_TAG" >> $GITHUB_OUTPUT

        echo "=== Build Info ==="
        echo "Tag: $TAG"
        echo "Version: $VERSION"
        echo "Build Number: $BUILD_NUM"
        echo "Is Tag: $IS_TAG"

    - name: Build Release APK (Unsigned)
      run: |
        echo "Building unsigned release APK..."
        flutter build apk \
          --release \
          --build-name="${{ steps.version.outputs.version }}" \
          --build-number="${{ steps.version.outputs.build_number }}" \
          --verbose

    - name: Build Debug APK
      run: |
        echo "Building debug APK..."
        flutter build apk \
          --debug \
          --build-name="${{ steps.version.outputs.version }}" \
          --build-number="${{ steps.version.outputs.build_number }}"

    - name: Prepare Release Files
      run: |
        # Create release directory
        mkdir -p release-files

        # Copy and rename APK files
        if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
          cp "build/app/outputs/flutter-apk/app-release.apk" \
             "release-files/lumma-${{ steps.version.outputs.tag }}-release.apk"
          echo "âœ… Release APK ready"
        fi

        if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
          cp "build/app/outputs/flutter-apk/app-debug.apk" \
             "release-files/lumma-${{ steps.version.outputs.tag }}-debug.apk"
          echo "âœ… Debug APK ready"
        fi

        # List files
        echo "ðŸ“¦ Release files:"
        ls -la release-files/

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lumma-apk-${{ steps.version.outputs.tag }}
        path: release-files/*.apk
        retention-days: 90

    - name: Create GitHub Release
      if: steps.version.outputs.is_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Lumma ${{ steps.version.outputs.tag }}
        files: release-files/*.apk
        body: |
          # ðŸŒŸ Lumma ${{ steps.version.outputs.tag }}

          **AIé©±åŠ¨çš„æ™ºèƒ½é—®ç­”æ—¥è®°åº”ç”¨**

          ## ðŸ“± ä¸‹è½½å®‰è£…

          ### APKæ–‡ä»¶è¯´æ˜Ž
          - **lumma-${{ steps.version.outputs.tag }}-release.apk**: å‘å¸ƒç‰ˆæœ¬ï¼ŒæŽ¨èä½¿ç”¨
          - **lumma-${{ steps.version.outputs.tag }}-debug.apk**: è°ƒè¯•ç‰ˆæœ¬ï¼Œç”¨äºŽå¼€å‘æµ‹è¯•

          ### å®‰è£…æ­¥éª¤
          1. ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. å®‰è£…APKæ–‡ä»¶
          4. é¦–æ¬¡ä½¿ç”¨æ—¶é…ç½®AIæ¨¡åž‹API

          ## âœ¨ ä¸»è¦åŠŸèƒ½
          - ðŸ¤– AIé—®ç­”å¼æ—¥è®°è®°å½•
          - ðŸŽ¨ æ·¡é›…/æ·±è‰²ä¸»é¢˜åˆ‡æ¢
          - ðŸ“ å¤šç§æ—¥è®°æ¨¡å¼
          - ðŸ’¬ æ™ºèƒ½é—®é¢˜ç”Ÿæˆ
          - ðŸ“± çŽ°ä»£åŒ–UIè®¾è®¡

          ## ðŸ”§ æŠ€æœ¯ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
          - **æž„å»ºå·**: ${{ steps.version.outputs.build_number }}
          - **æäº¤**: ${{ github.sha }}
          - **æž„å»ºæ—¶é—´**: ${{ github.run_started_at }}

          ---

          > ðŸ’¡ å¦‚æžœé‡åˆ°å®‰è£…æˆ–ä½¿ç”¨é—®é¢˜ï¼Œè¯·åœ¨Issuesä¸­åé¦ˆ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on Commit (for push events)
      if: github.event_name == 'push' && steps.version.outputs.is_release == 'false'
      run: |
        echo "ðŸ“± APKæž„å»ºå®Œæˆï¼"
        echo "æäº¤: ${{ github.sha }}"
        echo "APKå·²ä¸Šä¼ åˆ°Actions Artifactsï¼Œå¯åœ¨ä»¥ä¸‹ä½ç½®ä¸‹è½½ï¼š"
        echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    - name: Build Summary
      run: |
        if [ "${{ steps.version.outputs.is_release }}" == "true" ]; then
          echo "## ðŸŽ‰ Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ steps.version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Created**: âœ… Yes" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸ“± Commit Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ steps.version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Created**: âŒ No (commit build)" >> $GITHUB_STEP_SUMMARY
        fi

        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Generated Files" >> $GITHUB_STEP_SUMMARY
        echo "- Release APK: lumma-${{ steps.version.outputs.tag }}-release.apk" >> $GITHUB_STEP_SUMMARY
        echo "- Debug APK: lumma-${{ steps.version.outputs.tag }}-debug.apk" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Download Links" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.version.outputs.is_release }}" == "true" ]; then
          echo "- ðŸ“‹ [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- ðŸ“¦ [Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
