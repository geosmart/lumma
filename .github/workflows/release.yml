name: Release Build

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: lumma

jobs:
  releaseAndroid:
    name: Release Android
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.5'
          channel: 'stable'
          cache: true

      - name: Verify Flutter Installation
        run: |
          flutter config --no-analytics
          flutter doctor -v
          flutter --version

      - name: Install Dependencies
        run: flutter pub get

      - name: Extract Version Info
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(echo $TAG | sed 's/^v//')
          BUILD_NUM="${{ github.run_number }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

          echo "=== Build Info ==="
          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUM"

      - name: Create Environment File
        run: |
          cat > .env.release << EOF
          MODEL_PROVIDER=openrouter
          MODEL_BASE_URL=https://openrouter.ai/api/v1
          MODEL_API_KEY=sk-or-v1
          MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
          USE_LOCAL_CONFIG=false
          EOF

      - name: Setup Android Signing
        run: |
          # ä½¿ç”¨è°ƒè¯•ç­¾åè¿›è¡ŒGitHub Actionsæ„å»º
          # åœ¨androidç›®å½•ä¸‹åˆ›å»ºè°ƒè¯•keystoreçš„ç¬¦å·é“¾æ¥
          cd android
          if [ ! -f "app/debug.keystore" ]; then
            # å¦‚æœdebug.keystoreä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            keytool -genkey -v -keystore app/debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          fi

          # åˆ›å»ºä¸´æ—¶çš„release keystoreæŒ‡å‘debug keystore
          if [ ! -f "my-release-key.jks" ]; then
            cp app/debug.keystore my-release-key.jks
          fi

      - name: Build Android Release APK
        run: |
          flutter build apk \
            --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build_number }}" \
            --target-platform android-arm64 \
            --no-shrink

      - name: Prepare Release Files
        run: |
          mkdir -p release-files

          # Copy ARM64 APK file
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-release.apk" \
               "release-files/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_arm64.apk"
            echo "âœ… ARM64 APK ready"
          else
            echo "âŒ ARM64 APK not found"
            exit 1
          fi

          echo "ğŸ“¦ Release files:"
          ls -la release-files/

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: release-files/*.apk
          retention-days: 30

  releaseLinux:
    name: Release Linux AppImage
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.5'
          channel: 'stable'
          cache: true

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            wget \
            file \
            imagemagick \
            fuse

      - name: Verify Flutter Installation
        run: |
          flutter config --no-analytics
          flutter doctor -v
          flutter --version
          flutter config --enable-linux-desktop

      - name: Install Dependencies
        run: flutter pub get

      - name: Extract Version Info
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(echo $TAG | sed 's/^v//')
          BUILD_NUM="${{ github.run_number }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

          echo "=== Build Info ==="
          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUM"

      - name: Create Environment File
        run: |
          cat > .env.release << EOF
          MODEL_PROVIDER=openrouter
          MODEL_BASE_URL=https://openrouter.ai/api/v1
          MODEL_API_KEY=sk-or-v1
          MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
          USE_LOCAL_CONFIG=false
          EOF

      - name: Build Linux Release
        run: |
          flutter build linux \
            --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build_number }}" \
            --verbose

      - name: Verify Linux Build
        run: |
          echo "ğŸ” Verifying Linux build output..."
          if [ -d "build/linux/x64/release/bundle" ]; then
            echo "âœ… Linux build directory exists"
            ls -la build/linux/x64/release/bundle/

            if [ -f "build/linux/x64/release/bundle/lumma" ]; then
              echo "âœ… Lumma executable found"
              file build/linux/x64/release/bundle/lumma
            else
              echo "âŒ Lumma executable not found"
              exit 1
            fi
          else
            echo "âŒ Linux build directory not found"
            exit 1
          fi

      - name: Download AppImageTool
        run: |
          mkdir -p linux/build
          wget -O linux/build/appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x linux/build/appimagetool

      - name: Create AppImage Structure
        run: |
          APP_NAME="${{ env.APP_NAME }}"
          APP_DIR="linux/build/${APP_NAME}.AppDir"

          # Create AppDir structure
          mkdir -p $APP_DIR/usr/bin
          mkdir -p $APP_DIR/usr/lib
          mkdir -p $APP_DIR/usr/share/applications
          mkdir -p $APP_DIR/usr/share/icons/hicolor/256x256/apps

          # Copy the built application
          cp -r build/linux/x64/release/bundle/* $APP_DIR/usr/bin/

          # Copy required libraries
          echo "ğŸ“š Copying required libraries..."
          # Copy system libraries that might be needed
          mkdir -p $APP_DIR/usr/lib/x86_64-linux-gnu

          # Find and copy Flutter engine libraries
          if [ -d "build/linux/x64/release/bundle/lib" ]; then
            cp -r build/linux/x64/release/bundle/lib/* $APP_DIR/usr/lib/ 2>/dev/null || true
          fi

          # Create desktop file
          cat > $APP_DIR/usr/share/applications/$APP_NAME.desktop << EOF
          [Desktop Entry]
          Name=Lumma
          Comment=AI-powered Q&A Diary App
          Exec=$APP_NAME
          Icon=$APP_NAME
          Type=Application
          Categories=Office;
          StartupNotify=true
          EOF

          # Create AppRun script
          cat > $APP_DIR/AppRun << 'EOF'
          #!/bin/bash

          # Get the directory where this AppImage is located
          HERE="$(dirname "$(readlink -f "${0}")")"

          # Set up library paths
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"

          # Change to the application directory
          cd "${HERE}/usr/bin"

          # Execute the application
          exec "${HERE}/usr/bin/lumma" "$@"
          EOF
          chmod +x $APP_DIR/AppRun

          # Copy icon (use a default icon if app icon doesn't exist)
          if [ -f "assets/icon/icon.svg" ]; then
            # Convert JPG to PNG for better AppImage support
            convert "assets/icon/icon.svg" -resize 256x256 "$APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png"
            echo "âœ… Application icon converted and copied"
          else
            # Create a simple placeholder icon
            echo "âš ï¸ App icon not found, creating placeholder..."
            convert -size 256x256 xc:lightblue -pointsize 72 -fill darkblue -gravity center -annotate +0+0 "L" "$APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png" || \
            wget -O "$APP_DIR/usr/share/icons/hicolor/256x256/apps/$APP_NAME.png" https://via.placeholder.com/256x256/lightblue/darkblue?text=L
          fi

          # Create symlinks for desktop file and icon at root level
          ln -sf usr/share/applications/$APP_NAME.desktop $APP_DIR/
          ln -sf usr/share/icons/hicolor/256x256/apps/$APP_NAME.png $APP_DIR/

          echo "AppDir structure created:"
          find $APP_DIR -type f | head -20

      - name: Create AppImage
        run: |
          APP_NAME="${{ env.APP_NAME }}"
          VERSION="${{ steps.version.outputs.version }}"
          APP_DIR="linux/build/${APP_NAME}.AppDir"

          # Create AppImage
          ./linux/build/appimagetool "${APP_DIR}" "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage"

          # Verify AppImage was created
          if [ -f "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage" ]; then
            echo "âœ… AppImage created successfully"
            ls -la "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage"
            file "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage"

            # Test AppImage structure
            echo "ğŸ” Testing AppImage structure..."
            ./linux/build/appimagetool --appimage-extract-and-run "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage" --help 2>/dev/null || echo "AppImage help test completed"

            # Make the AppImage executable
            chmod +x "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage"

            echo "ğŸ“Š AppImage size: $(du -h "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage" | cut -f1)"
          else
            echo "âŒ AppImage creation failed"
            echo "Available files in linux/build/:"
            ls -la linux/build/ || echo "Build directory not found"
            exit 1
          fi

      - name: Prepare Linux Release Files
        run: |
          mkdir -p release-files-linux

          VERSION="${{ steps.version.outputs.version }}"
          APP_NAME="${{ env.APP_NAME }}"

          # Copy AppImage
          if [ -f "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage" ]; then
            cp "linux/build/${APP_NAME}-${VERSION}-x86_64.AppImage" \
               "release-files-linux/${APP_NAME}_${VERSION}_linux_x86_64.AppImage"
            echo "âœ… Linux AppImage ready"
          else
            echo "âŒ Linux AppImage not found"
            exit 1
          fi

          echo "ğŸ“¦ Linux Release files:"
          ls -la release-files-linux/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: release-files-linux/*.AppImage
          retention-days: 30

  releaseiOS:
    name: Release iOS
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.5'
          channel: 'stable'
          cache: true

      - name: Verify Flutter Installation
        run: |
          flutter config --no-analytics
          flutter doctor -v
          flutter --version

      - name: Install Dependencies
        run: flutter pub get

      - name: Extract Version Info
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(echo $TAG | sed 's/^v//')
          BUILD_NUM="${{ github.run_number }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

          echo "=== Build Info ==="
          echo "Tag: $TAG"
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUM"

      - name: Create Environment File
        run: |
          cat > .env.release << EOF
          MODEL_PROVIDER=openrouter
          MODEL_BASE_URL=https://openrouter.ai/api/v1
          MODEL_API_KEY=sk-or-v1
          MODEL_NAME=deepseek/deepseek-chat-v3-0324:free
          USE_LOCAL_CONFIG=false
          EOF

      - name: Setup iOS Environment
        run: |
          # æ£€æŸ¥Xcodeç‰ˆæœ¬å’ŒiOSæ¨¡æ‹Ÿå™¨
          echo "Setting up iOS build environment"
          xcodebuild -version
          xcrun simctl list devices | head -10

          # å®‰è£…CocoaPodsä¾èµ–
          cd ios
          sudo gem install cocoapods --version 1.15.2
          pod install --repo-update

      - name: Clean iOS Build
        run: |
          cd ios
          xcodebuild clean -workspace Runner.xcworkspace -scheme Runner -configuration Release
          rm -rf build/

      - name: Build iOS Release App
        run: |
          flutter build ios \
            --release \
            --build-name="${{ steps.version.outputs.version }}" \
            --build-number="${{ steps.version.outputs.build_number }}" \
            --no-codesign \
            --verbose

      - name: Create iOS Archive
        run: |
          cd ios

          # åˆ›å»ºarchive
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/Runner.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            archive

      - name: Create IPA from Archive
        run: |
          cd ios

          # æ£€æŸ¥archiveæ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -d "build/Runner.xcarchive" ]; then
            echo "âŒ Archive not found!"
            exit 1
          fi

          # æå–.appæ–‡ä»¶å¹¶åˆ›å»ºIPA
          APP_PATH="build/Runner.xcarchive/Products/Applications/Runner.app"
          if [ -d "$APP_PATH" ]; then
            echo "âœ… Found Runner.app"

            # åˆ›å»ºPayloadç›®å½•ç»“æ„
            mkdir -p build/Payload
            cp -r "$APP_PATH" build/Payload/

            # åˆ›å»ºIPAæ–‡ä»¶
            cd build
            zip -r Runner.ipa Payload/
            echo "âœ… IPA created successfully"
          else
            echo "âŒ Runner.app not found in archive"
            ls -la build/Runner.xcarchive/Products/ || echo "Products directory not found"
            exit 1
          fi

      - name: Prepare iOS Release Files
        run: |
          mkdir -p release-files-ios

          # æŸ¥æ‰¾å¹¶å¤åˆ¶IPAæ–‡ä»¶
          if [ -f "ios/build/Runner.ipa" ]; then
            cp "ios/build/Runner.ipa" \
               "release-files-ios/${{ env.APP_NAME }}_${{ steps.version.outputs.version }}_ios.ipa"
            echo "âœ… iOS IPA ready"
          else
            echo "âŒ iOS IPA not found"
            echo "Available files in ios/build/:"
            ls -la ios/build/ || echo "Build directory not found"
            exit 1
          fi

          echo "ğŸ“¦ iOS Release files:"
          ls -la release-files-ios/

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: release-files-ios/*.ipa
          retention-days: 30

  createRelease:
    name: Create Unified Release
    runs-on: ubuntu-22.04
    needs: [releaseAndroid, releaseLinux, releaseiOS]
    if: always() && (needs.releaseAndroid.result == 'success' || needs.releaseLinux.result == 'success' || needs.releaseiOS.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Version Info
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(echo $TAG | sed 's/^v//')
          BUILD_NUM="${{ github.run_number }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUM" >> $GITHUB_OUTPUT

      - name: Download Android Artifacts
        if: needs.releaseAndroid.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: android-release
          path: ./artifacts/android/
        continue-on-error: true

      - name: Download Linux Artifacts
        if: needs.releaseLinux.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: linux-release
          path: ./artifacts/linux/
        continue-on-error: true

      - name: Download iOS Artifacts
        if: needs.releaseiOS.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ios-release
          path: ./artifacts/ios/
        continue-on-error: true

      - name: Create Unified Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ env.APP_NAME }} ${{ steps.version.outputs.tag }}
          files: |
            ./artifacts/android/*.apk
            ./artifacts/linux/*.AppImage
            ./artifacts/ios/*.ipa
          body: |
            # ğŸŒŸ ${{ env.APP_NAME }} ${{ steps.version.outputs.tag }}

            **AI-powered Q&A Diary App / AIé©±åŠ¨çš„æ™ºèƒ½é—®ç­”æ—¥è®°åº”ç”¨**

            ## ğŸ”§ Technical Info / æŠ€æœ¯ä¿¡æ¯
            - **Version / ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}
            - **Build Number / æ„å»ºå·**: ${{ steps.version.outputs.build_number }}
            - **Commit / æäº¤**: ${{ github.sha }}
            - **Flutter Version / Flutterç‰ˆæœ¬**: 3.32.5

            ## ğŸ“± Platform Support / å¹³å°æ”¯æŒ

            ### Android
            ${{ needs.releaseAndroid.result == 'success' && 'âœ… APK available for download' || 'âŒ Android build failed' }}

            ### iOS
            ${{ needs.releaseiOS.result == 'success' && 'âœ… IPA available for download' || 'âŒ iOS build failed' }}

            ### Linux
            ${{ needs.releaseLinux.result == 'success' && 'âœ… AppImage available for download' || 'âŒ Linux build failed' }}

            ## ğŸ“ Installation Notes / å®‰è£…è¯´æ˜

            ### Android
            - Direct installation from APK file
            - ç›´æ¥ä»APKæ–‡ä»¶å®‰è£…

            ### iOS
            > âš ï¸ This is an unsigned development build. You may need to trust the developer certificate in iOS Settings > General > VPN & Device Management.
            > âš ï¸ è¿™æ˜¯æœªç­¾åçš„å¼€å‘ç‰ˆæœ¬ï¼Œä½ å¯èƒ½éœ€è¦åœ¨iOSè®¾ç½® > é€šç”¨ > VPNä¸è®¾å¤‡ç®¡ç†ä¸­ä¿¡ä»»å¼€å‘è€…è¯ä¹¦ã€‚

            ### Linux
            - Download the AppImage file
            - Make it executable: `chmod +x lumma_*.AppImage`
            - Run directly: `./lumma_*.AppImage`
            - ä¸‹è½½AppImageæ–‡ä»¶ï¼Œè®¾ç½®å¯æ‰§è¡Œæƒé™åç›´æ¥è¿è¡Œ
            ---

            > ğŸ’¡ If you encounter installation or usage issues, please report them in Issues.
            > ğŸ’¡ å¦‚æœé‡åˆ°å®‰è£…æˆ–ä½¿ç”¨é—®é¢˜ï¼Œè¯·åœ¨Issuesä¸­åé¦ˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
